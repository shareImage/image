
扑溯迷离的根因分析

## 业务结构

![image-20230517113148916](https://cdn.jsdelivr.net/gh/shareImage/image@_md2zhihu_blog_cee8f3b4/根因分析/60b864e9c86cdc54-image-20230517113148916.png)

## 监控数据

如图，蓝线表示service1，黑线表示service2被调用方，可以看到每次黑色 RT上升QPS下跌很猛(符合预期)，奇怪的是黑色RT很快降下来后蓝色RT还会维持较高一段时间，监控频率每5秒采集一次，以下所有监控图时间范围是一样的，但采集频率不一样

![image-20230516150350614](https://cdn.jsdelivr.net/gh/shareImage/image@_md2zhihu_blog_cee8f3b4/根因分析/8b3339cca9cf5c1f-image-20230516150350614.png)

上图的两个 RT 监控数据都是service1的业务代码记录下来的，比如service2的响应时间就包含网络+service2的处理时间

如下图通过网络监控看响应时间(tcprt，从OS 内核中取到网络包的响应时间)，蓝线表示service1，紫线表示service2，监控力度每1分钟采集一次，有被平均

![image-20230516150812485](https://cdn.jsdelivr.net/gh/shareImage/image@_md2zhihu_blog_cee8f3b4/根因分析/ffa0189154206041-image-20230516150812485.png)

以上两个监控图的矛盾点：如果从网络层面记录的service2 RT 可以看到上升幅度不明显，但是service1 的RT上升很明显，但是service1记录的RT则又是service2 上升明显。

service1 CPU 监控

![image-20230516150950383](https://cdn.jsdelivr.net/gh/shareImage/image@_md2zhihu_blog_cee8f3b4/根因分析/73b453c7a2079d27-image-20230516150950383.png)

## 问题

可以很清楚看到 QPS 下降是因为 RT上升，那么究竟是service2的RT上升导致的还是service1的RT上升导致的



Reference:

